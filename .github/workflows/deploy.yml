# .github/workflows/deploy.yml
name: Generate env.js on Push to Main

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  generate-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate env.js file
        run: |
          echo "// Auto-generated by GitHub Actions on $(date)" > env.js
          echo "import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.4';" >> env.js
          echo "" >> env.js
          echo "// Supabase configuration" >> env.js
          echo "const supabaseUrl = '${{ secrets.SUPABASE_URL }}';" >> env.js
          echo "const supabaseKey = '${{ secrets.SUPABASE_ANON_KEY }}';" >> env.js
          echo "" >> env.js
          echo "// Create and export the Supabase client" >> env.js
          echo "export const supabase = createClient(supabaseUrl, supabaseKey, {" >> env.js
          echo "  auth: {" >> env.js
          echo "    autoRefreshToken: true," >> env.js
          echo "    persistSession: true," >> env.js
          echo "    detectSessionInUrl: true," >> env.js
          echo "    storage: window.localStorage" >> env.js
          echo "  }" >> env.js
          echo "});" >> env.js
          echo "" >> env.js
          echo "// Flutterwave configuration" >> env.js
          echo "const FLUTTERWAVE_PUBLIC_KEY = '${{ secrets.FLUTTERWAVE_PUBLIC_KEY }}';" >> env.js
          echo "" >> env.js
          echo "// Export Flutterwave public key" >> env.js
          echo "export const FLWPUBK = FLUTTERWAVE_PUBLIC_KEY;" >> env.js
          echo "" >> env.js
          echo "// Export auth, db, and storage for compatibility with existing code" >> env.js
          echo "export const auth = supabase.auth;" >> env.js
          echo "export const db = supabase;" >> env.js
          echo "export const storage = supabase.storage;" >> env.js
          echo "export const messaging = null; // Firebase messaging is not used" >> env.js
          echo "" >> env.js
          echo "console.log('âœ… Environment configuration loaded from CI/CD workflow.');" >> env.js

      - name: Commit and push env.js
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: auto-generate env.js from secrets"
          file_pattern: env.js
          commit_user_name: StatWise Bot
          commit_user_email: bot@statwise.com
          commit_author: StatWise Bot <bot@statwise.com>
