rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Secure rule for the main users collection.
    match /users/{userId} {
      // A user can create their own document upon signup.
      allow create: if request.auth != null;
      
      // A user can read, update, or delete their own document.
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      
      // Allow anyone (including unauthenticated users on the signup page) to query for users
      // by their referral code, but not read the entire document.
      // Also allow authenticated users to read documents of users they referred.
      allow list: if request.auth != null || request.query.where[0][0] == "referralCode";
      // Rules for subcollections like 'history'
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // New, secure rules for the dedicated referral code collection.
    match /referralCodes/{code} {
      // Anyone can read referral codes to check if they are valid.
      // This is safe because it only exposes the referrer's username.
      allow read: if true;

      // A user can only create a referral code document if the userId inside
      // the document matches their own authenticated UID.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Prevent clients from updating or deleting referral codes.
      allow update, delete: if false;
    }

    // Rules for other collections
    match /subscriptions/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /rewards/{rewardId} {
        // Allow the referrer to read the reward details.
        allow read: if request.auth != null && request.auth.uid == resource.data.referrerId;

        // Allow creation by a server-side process (like a Cloud Function)
        // or a trusted client action where the creator is verified.
        // For now, we'll allow any authenticated user to create a reward,
        // assuming a Cloud Function will validate and create it in production.
        allow create: if request.auth != null;

        // Only allow updates (like claiming) by the referrer.
        allow update: if request.auth != null && request.auth.uid == resource.data.referrerId;
    }
  }
}